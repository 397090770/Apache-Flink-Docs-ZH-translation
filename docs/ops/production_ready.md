---
title: "生产环境检查清单"
nav-parent_id: setup
nav-pos: 20
---
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

* ToC
{:toc}

## 生产环境检查清单

生产环境检查清单的目的是，当发布Flink任务到**生产环境**时，清单提供简要概述一些重要且需要**仔细考虑**配置项。 
大多数参数Flink在安装时提供了的默认设置，使Flink的使用和采用更加容易。 
对于大多数用户和场景，那些默认参数是一个好的起点，完全适用于一次性的任务。 

然而，一旦计划将Flink应用程序发布到生产环境，对配置的要求就会提高。 
例如，如果需要（重新）扩展或升级Flink任务，又或者升级Flink的版本。 

下文中，我们将介绍一系列配置选项，发布到生产环境前，必须先检查这些配置选项。

### 设置 operator 的最大并行度

最大并行度是Flink 1.2中新引入的配置参数，对Flink任务（重新）扩展性具有重要的意义。
该参数可以对每个job和/或每个 operator 的粒度来设置您可以扩展operator的最大并行度。
需要知道的是一旦任务运行后，将**没有办法改变**这个参数，除非完全重新启动你的任务（比如重一个新状态开始，而不是来自先前的checkpoint/savepoint）。

即使Flink将来可能提供一些方法对现有savepoints改变的最大并行性，但是你需要知道的是这将是你需要避免的长运行操作。
在这一点上，您可能会想知道为什么不给该参数一个非常高的值的默认值。
这样做的原因是高最大并行度可以对你有一些影响应用程序的性能甚至状态大小，
因为Flink必须维护一定元数据来保证它有重新伸缩的能力，从而可以提升最大的平行度增加。

一般来说，你应该选择一个最大的并行度足以保证你的未来的可扩展性需求，
但保持尽可能低的值可以提供略微更好的性能。尤其是，最大并行度高于128将通常导致 keyed backends 产生稍微更大的状态快照。

请注意，最大并行度必须满足以下条件： 

`0 < parallelism  <= max parallelism <= 2^15`

可以通过 `setMaxParallelism（int maxparallelism)` 设置最大并行度。 
默认情况下，Flink会选择最大值并行性作为工作首次启动时的:
You can set the maximum parallelism by `setMaxParallelism(int maxparallelism)`. By default, Flink will choose the maximum
parallelism as a function of the parallelism when the job is first started:

- `128` : for all parallelism <= 128.
- `MIN(nextPowerOfTwo(parallelism + (parallelism / 2)), 2^15)` : for all parallelism > 128.

### Set UUIDs for operators

As mentioned in the documentation for [savepoints]({{ site.baseurl }}/setup/savepoints.html, users should set uids for
operators. Those operator uids are important for Flink's mapping of operator states to operators which, in turn, is 
essential for savepoints. By default operator uids are generated by traversing the JobGraph and hashing certain operator 
properties. While this is comfortable from a user perspective, it is also very fragile, as changes to the JobGraph (e.g.
exchanging an operator) will result in new UUIDs. To establish a stable mapping, we need stable operator uids provided 
by the user through `setUid(String uid)`.

### Choice of state backend

Currently, Flink has the limitation that it can only restore the state from a savepoint for the same state backend that
took the savepoint. For example, this means that we can not take a savepoint with a memory state backend, then change
the job to use a RocksDB state backend and restore. While we are planning to make backends interoperable in the near
future, they are not yet. This means you should carefully consider which backend you use for your job before going to
production.

In general, we recommend using RocksDB because this is currently the only state backend that supports large states (i.e.
state that exceeds the available main memory) and asynchronous snapshots. From our experience, asynchronous snapshots are
very important for large states because they do not block the operators and Flink can write the snapshots without stopping 
stream processing. However, RocksDB can have worse performance than, for example, the memory-based state backends. If
you are sure that your state will never exceed main memory and blocking the stream processing to write it is not an issue,
you **could consider** to not use the RocksDB backends. However, at this point, we **strongly recommend** using RocksDB
for production.